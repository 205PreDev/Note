# 설계 문서

## 1. UI/UX 디자인

### 1.1. 디자인 원칙

- **단순함 (Simplicity)**: 불필요한 기능을 최소화하고 핵심에 집중한다.
- **직관성 (Intuitiveness)**: 사용자가 고민 없이 자연스럽게 사용할 수 있는 인터페이스를 제공한다.
- **가독성 (Readability)**: 명확한 폰트와 적절한 여백을 사용하여 콘텐츠 가독성을 높인다.
- **계층별 UI 명확성**: 사용자 계층(비회원, 회원, 프리미엄)에 따라 접근 가능한 기능과 UI 요소를 명확히 구분하여 사용자에게 혼란을 주지 않도록 설계한다.

### 1.2. 화면 구성 (Screen Flow)

1.  **시작/로그인 화면**: 앱 실행 시 사용자 계층 선택 (비회원 시작, 로그인/회원가입)
2.  **노트 목록 화면 (Note List Screen)**:
    - 앱 실행 시 가장 먼저 보이는 화면.
    - 저장된 노트 목록이 최신순으로 나열된다.
    - 새 노트를 작성하기 위한 '추가(+)' 버튼이 있다.
    - 각 목록 아이템을 탭하면 '노트 상세/수정 화면'으로 이동한다.
    - 비회원은 로컬 노트만, 회원은 클라우드 노트(프로젝트별)를 볼 수 있다.
3.  **노트 상세/수정 화면 (Note Detail/Editor Screen)**:
    - 노트 내용을 보여주거나 편집하는 화면.
    - 상단 네비게이션 바에 필기 도구 및 메뉴('...') 버튼이 위치한다.
    - 강화된 편집 기능(서식, 목록, 테이블, 파일 첨부 등)을 위한 UI 요소 포함.
    - 변경 사항은 자동으로 저장되거나, '저장' 버튼을 통해 저장된다.
4.  **프로젝트 목록 화면 (Project List Screen)**: (회원 전용)
    - 사용자가 생성하거나 참여한 프로젝트 목록을 보여준다.
    - 새 프로젝트 생성 버튼이 있다.
    - 각 프로젝트를 탭하면 해당 프로젝트의 노트 목록으로 이동한다.
    - 무료 회원은 1개 프로젝트 제한, 프리미엄은 무제한.
5.  **템플릿 선택 화면**: (회원 전용)
    - 사용 가능한 기본 템플릿 목록을 보여준다.
    - 프리미엄 사용자는 고급 템플릿 및 사용자 정의 템플릿 생성/관리 옵션 제공.
6.  **구독 관리 화면**: (회원 전용)
    - 현재 구독 상태를 보여주고, 구독 플랜 변경 또는 취소 옵션을 제공한다.
    - 인앱 결제 UI와 연동된다.

## 2. 기술 아키텍처

### 2.1. 개발 프레임워크

- **React Native**: JavaScript/TypeScript 및 React를 기반으로 하는 크로스플랫폼 프레임워크.
    - **선택 이유**:
        - **크로스플랫폼 개발**: 하나의 코드베이스로 iOS와 Android 앱을 동시에 개발하여 개발 시간과 비용을 절감합니다.
        - **JavaScript/TypeScript 기반**: 웹 개발 경험이 있는 팀원에게 익숙하며, 풍부한 JavaScript 생태계의 라이브러리를 활용할 수 있습니다.
        - **활발한 커뮤니티 및 생태계**: 문제 발생 시 해결책을 찾기 용이하며, 다양한 오픈소스 라이브러리를 통해 개발 생산성을 높일 수 있습니다.
        - **빠른 개발 주기**: Hot Reloading 기능 등으로 UI 변경 사항을 즉시 확인하며 빠르게 개발할 수 있습니다.

### 2.2. 상태 관리 (State Management)

- **Redux Toolkit** 또는 **Zustand** 사용을 권장. 앱의 복잡성을 고려하여 전역 상태를 효율적으로 관리.
    - **Redux Toolkit 추천 이유**:
        - **간결한 설정**: Redux의 복잡한 초기 설정을 단순화하여 boilerplate 코드를 줄여줍니다.
        - **내장된 유틸리티**: 비동기 로직 처리를 위한 Redux Thunk, 상태 선택을 위한 Reselect 등이 기본 포함되어 있습니다.
        - **확장성**: 대규모 애플리케이션에서 예측 가능한 상태 관리가 가능하며, 강력한 개발자 도구를 제공합니다.
    - **Zustand 추천 이유**:
        - **경량성 및 단순성**: 매우 가볍고 배우기 쉬우며, 최소한의 코드로 전역 상태를 관리할 수 있습니다.
        - **훅 기반 API**: React Hooks와 유사한 직관적인 API를 제공하여 사용하기 편리합니다.
        - **유연성**: 작은 규모의 프로젝트부터 중간 규모 프로젝트까지 유연하게 적용할 수 있습니다.

### 2.3. 데이터 저장소 (Data Storage)

- **하이브리드 데이터 전략**: 로컬 데이터베이스와 클라우드 데이터베이스를 함께 사용한다.
    - **로컬 데이터베이스**: **WatermelonDB** 또는 **react-native-sqlite-storage**를 사용하여 모든 노트 데이터를 기기에 저장. 비회원 사용자의 주 저장소이며, 회원 사용자의 오프라인 캐시 역할.
    - **클라우드 데이터베이스**: **Supabase (PostgreSQL)**를 사용하여 회원 및 프리미엄 사용자의 노트 데이터를 저장.
- **데이터 동기화 전략**:
    - **비회원 -> 회원 전환 시**: 로컬에 저장된 모든 노트를 Supabase 클라우드 데이터베이스로 마이그레이션/업로드. 충돌 해결 전략 필요.
    - **회원 로그인 후**: 로컬 DB와 Supabase DB 간의 지속적인 양방향 동기화. 오프라인 상태에서 변경된 내용은 온라인 전환 시 동기화.
- **데이터 모델**:
    - `User`: Supabase Auth와 연동. `id`, `email`, `subscription_status` 등.
    - `Project`: `id`, `user_id` (생성자), `name`, `created_at`, `updated_at`.
    - `Note`: `id`, `project_id`, `user_id` (생성자), `content` (리치 텍스트), `created_at`, `updated_at`.
    - `Page`: `id`, `note_id`, `content` (노트 내 섹션/하위 노트).
    - `Attachment`: `id`, `note_id`, `file_url`, `file_type`, `file_size`, `uploaded_at`. (Supabase Storage 연동)
    - `Template`: `id`, `user_id` (사용자 정의 템플릿의 경우), `name`, `content`, `type` (기본/고급/사용자정의).
    - `Collaboration`: `project_id`, `user_id`, `role` (읽기/편집).

### 2.4. 인증 및 사용자 관리

- **Supabase Auth**: 이메일/비밀번호, Google, Apple 등 소셜 로그인 연동.
- **사용자 계층 관리**: Supabase 데이터베이스에 사용자 `subscription_status` 필드를 추가하여 회원/프리미엄 상태 관리.
- **역할 기반 접근 제어 (RLS)**: Supabase의 Row Level Security를 활용하여 사용자 계층 및 프로젝트 권한에 따른 데이터 접근 제어.

### 2.5. 프로젝트 폴더 구조 (예시)

```
src/
├── api/            # 외부 API 연동 (AI 사전, Supabase 등)
├── auth/           # 인증 관련 로직 및 UI
├── components/     # 재사용 가능한 공통 컴포넌트
├── config/         # 환경 설정 및 상수
├── data/           # 로컬 DB 및 클라우드 DB 연동 로직
│   ├── local/      # WatermelonDB/SQLite 관련
│   └── remote/     # Supabase 관련
├── editors/        # 강화된 노트 편집기 관련 컴포넌트 및 로직
├── models/         # 데이터 모델 (User, Project, Note, Page, Attachment, Template)
├── navigation/     # 화면 이동 및 내비게이션 스택
├── screens/        # 각 화면 컴포넌트 (Auth, ProjectList, NoteList, NoteEditor, Subscription, TemplateSelection)
├── services/       # 비즈니스 로직 (동기화, 기능 게이팅 등)
├── state/          # Redux/Zustand 상태 관리
├── templates/      # 템플릿 관련 로직 및 데이터
├── utils/          # 유틸리티 함수
└── App.tsx         # 앱 진입점
```

### 2.6. 기능 게이팅 (Feature Gating)

- **클라이언트 측 로직**: 사용자 로그인 상태 및 구독 상태(Supabase Auth/DB에서 조회)를 기반으로 UI 요소 및 기능 접근을 제어.
- **서버 측 검증**: Supabase RLS를 통해 데이터 접근 권한을 최종적으로 검증하여 보안 강화.
- **AI 기능 사용량 제한**: 클라이언트에서 사용량을 추적하고, Supabase Edge Functions를 통해 서버에서 사용량 검증 및 리셋 로직 구현.
- **클라우드 저장 공간 제한**: Supabase Storage Quotas (if applicable) 또는 커스텀 로직으로 파일 첨부 용량 및 개수 제한.

### 2.7. 협업 아키텍처

- **제한된 협업 (보기만 가능)**:
    - Supabase RLS를 통해 특정 프로젝트에 대한 읽기 권한만 부여.
    - 프로젝트 공유 시 고유 링크 생성 및 접근 제어.
- **확장된 협업 (공동 편집)**:
    - **Supabase Realtime**: 실시간 데이터 변경 사항을 구독하여 여러 사용자가 동시에 노트를 편집할 때 동기화.
    - **CRDT (Conflict-free Replicated Data Types)** 라이브러리 고려: 오프라인 편집 및 충돌 없는 병합을 위해 Yjs 또는 Automerge 같은 라이브러리 도입 검토.

### 2.8. 결제 시스템 연동

- **인앱 결제 SDK**: `react-native-iap` 라이브러리 등을 사용하여 Apple App Store (StoreKit) 및 Google Play Billing 연동.
- **영수증 검증**: Supabase Edge Functions 또는 별도 백엔드 서버를 통해 결제 영수증을 검증하고, 사용자 구독 상태를 Supabase DB에 업데이트.
- **구독 상태 관리**: 사용자 구독 상태 변경 시 앱 내 기능 게이팅 로직이 즉시 반영되도록 구현.

## 3. 주요 기능 상세 설계 (사용자 제안)

### 3.1. 분할 화면 기능

- **구현 방향**: React Native 기본 컴포넌트로는 지원이 어려움. `react-native-split-view` 같은 서드파티 라이브러리를 사용하거나, 필요시 네이티브 모듈을 직접 개발하여 구현.
- **초기 목표**: 두 개의 텍스트 뷰를 좌우로 분할하고, 구분선의 드래그를 통해 비율을 조절하는 기능부터 구현.
- **계층**: 회원(무료 가입) 이상 사용자에게 제공.

### 3.2. AI 사전 (PIP 모드)

- **개념 정의**: OS 수준의 PIP가 아닌, 앱 내에서 항상 위에 떠 있는 **플로팅 뷰(Floating View)** 형태로 구현.
- **UI 구현**:
    - `react-native-reanimated`와 `react-native-gesture-handler`를 조합하여 드래그로 이동 및 크기 조절이 가능한 커스텀 뷰를 구현.
    - `react-native-modal` 라이브러리를 기반으로 커스터마이징하는 방법도 고려.
- **AI 연동**:
    - 외부 LLM(대규모 언어 모델) 서비스 (예: OpenAI API, Gemini API)를 사용.
    - `api/` 폴더 내에 API 클라이언트를 구현하여, 사용자가 선택/입력한 텍스트를 서버로 보내고 결과를 받아오는 기능 개발.
- **텍스트 상호작용**:
    - 노트 편집창(`TextInput`)에서 사용자가 텍스트를 선택(onSelectionChange)했을 때, 그 정보를 AI 사전 뷰로 전달하는 로직 필요.
- **계층**: 회원(무료 가입)에게는 제한된 사용량, 프리미엄 구독자에게는 무제한 사용 제공.

### 3.3. 고급 AI 기능

- **AI 요약**: 노트 내용을 분석하여 핵심 내용을 요약.
- **AI 기반 노트 정리/분류**: 노트의 내용을 분석하여 적절한 태그나 카테고리를 제안하거나, 자동으로 분류.
- **구현 방향**: AI 사전과 동일하게 외부 LLM 서비스 연동.
- **계층**: 프리미엄 구독자에게만 제공.

### 3.4. 강화된 노트 편집 기능

- **구현 방향**:
    - **리치 텍스트 에디터 라이브러리**: `react-native-pell-rich-editor` 또는 `react-native-render-html` (렌더링용) 등을 검토. 필요시 커스텀 에디터 구현.
    - **저장 형식**: 노트 내용은 HTML, Markdown 또는 JSON (예: Quill Delta) 형식으로 저장하여 서식 정보를 유지.
    - **파일 첨부**: Supabase Storage를 사용하여 파일을 업로드하고, 노트 내용에 파일 URL을 삽입.
    - **Undo/Redo**: 에디터 라이브러리 내장 기능 활용 또는 커스텀 스택 구현.
    - **테이블/체크리스트**: 에디터 라이브러리 지원 여부 확인 및 커스텀 구현.
- **계층**: `REQUIREMENTS.md`의 4.1, 4.2, 4.3 기능 요구사항에 따라 계층별로 제공.

### 3.5. 템플릿 제공 기능

- **구현 방향**:
    - **템플릿 데이터 모델**: `Template` 테이블에 템플릿 내용, 이름, 타입(기본/고급/사용자정의) 저장.
    - **템플릿 선택 UI**: 템플릿 목록을 보여주고 선택 시 새 노트에 템플릿 내용 로드.
    - **사용자 정의 템플릿**: 사용자가 기존 노트를 템플릿으로 저장하거나, 빈 템플릿을 생성하여 편집 후 저장.
    - **템플릿 공유**: Supabase RLS 및 공유 링크를 통해 다른 사용자에게 템플릿 접근 권한 부여.
- **계층**: `REQUIREMENTS.md`의 4.2, 4.3 기능 요구사항에 따라 계층별로 제공.