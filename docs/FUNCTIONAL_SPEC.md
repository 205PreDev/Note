# 모바일 필기 앱 - 기능 명세서 초안

이 문서는 '모바일 필기 앱'의 주요 기능에 대한 상세한 동작 방식을 정의합니다. 각 기능의 사용자 인터페이스, 사용자 상호작용, 시스템 응답 등을 명세합니다.

## 0. 공통 정의

### 0.1. 노트 객체 구조 예시
노트 데이터는 다음과 같은 구조를 가집니다. (실제 구현 시 확장될 수 있음)
```json
{
  "id": "UUID",
  "title": "String",
  "content": { /* JSONB 블록 기반 구조 */ },
  "created_at": "Timestamp",
  "updated_at": "Timestamp",
  "user_id": "UUID",
  "project_id": "UUID (nullable)",
  "is_deleted": "Boolean",
  "local_only": "Boolean",
  "format_info": { /* 서식 정보 (예: 볼드, 이탤릭 등) */ }
}
```

### 0.2. 공통 오류 처리 규칙
앱 내에서 발생하는 다양한 오류 상황에 대해 일관된 사용자 경험을 제공합니다.
*   **네트워크 오류:** 네트워크 연결이 불안정하거나 끊겼을 때 사용자에게 알림을 표시하고, 재시도 옵션을 제공합니다.
*   **데이터베이스 오류:** 로컬 또는 클라우드 데이터베이스 작업 중 오류 발생 시 사용자에게 알림을 표시하고, 데이터 무결성을 유지하기 위한 조치를 취합니다.
*   **권한 오류:** 사용자 계층별 접근 권한이 없는 기능에 접근 시, 적절한 메시지를 표시하고 해당 기능 사용을 제한합니다.
*   **충돌 발생:** 동기화 중 데이터 충돌 발생 시, 사용자에게 알림을 제공하고 충돌 해결 정책(예: Last Writer Wins)에 따라 처리합니다.

## 1. 노트 생성 기능

### 1.1. 개요
사용자가 새로운 노트를 생성하고, 내용을 입력하며, 저장하는 기능을 제공합니다. 비회원, 회원, 프리미엄 구독자 모두에게 제공되는 공통 기능입니다.

### 1.2. 사용자 인터페이스 (UI)
*   **메인 화면:** 하단 또는 상단에 '새 노트 생성' 버튼 (예: '+' 아이콘)이 위치합니다. (UI/UX 설계 문서에서 구체적인 위치 및 아이콘 확정)
*   **노트 편집 화면:** (UI/UX 설계 문서에서 와이어프레임/스케치 연결)
    *   상단: '뒤로 가기' 버튼, '저장' 버튼 (자동 저장 기능 시 생략 가능), '더보기' 메뉴 (AI 기능, 공유 등)
    *   중앙: 노트 제목 입력 필드, 노트 내용 입력 에디터
    *   하단: 기본 서식 도구 모음 (볼드, 이탤릭, 밑줄 등)

### 1.3. 사용자 상호작용
1.  **새 노트 생성:** 사용자가 메인 화면에서 '새 노트 생성' 버튼을 탭합니다.
2.  **노트 편집 화면 진입:** 앱은 빈 노트 편집 화면으로 전환됩니다.
3.  **제목 입력:** 사용자가 '제목' 필드를 탭하여 노트 제목을 입력합니다.
4.  **내용 입력:** 사용자가 내용 에디터를 탭하여 노트 본문을 입력합니다.
5.  **서식 적용:** 사용자가 텍스트를 선택하고 하단 도구 모음에서 원하는 서식 버튼을 탭하여 적용합니다.
6.  **저장:**
    *   **자동 저장:** 사용자가 편집 화면을 벗어나거나, **5초마다**, 또는 **포커스 아웃 시점**에 자동으로 노트가 저장됩니다.
    *   **수동 저장 (선택 사항):** 사용자가 '저장' 버튼을 탭하여 명시적으로 저장할 수 있습니다.

### 1.4. 시스템 응답
1.  **노트 생성 요청 시:**
    *   앱은 새로운 노트 객체를 생성하고, 고유 ID를 할당합니다.
    *   노트 객체는 즉시 로컬 데이터베이스에 저장됩니다.
    *   노트 편집 화면으로 전환됩니다.
2.  **내용 입력 및 서식 적용 시:**
    *   입력된 텍스트와 적용된 서식이 실시간으로 화면에 반영됩니다.
3.  **저장 시:**
    *   로컬 데이터베이스에 노트의 최신 내용이 업데이트됩니다.
    *   **회원/프리미엄 구독자:** 백그라운드에서 Supabase 클라우드 데이터베이스로 동기화 요청이 전송됩니다.
        *   **동기화 실패 시:** 최대 3회 재시도 (백오프 정책 적용), 이후 사용자에게 알림 제공 및 수동 동기화 옵션 제공.
    *   **비회원:** 로컬에만 저장되며, 로컬 저장 공간 정책(최대 개수)을 초과할 경우 사용자에게 알림을 제공합니다.
    *   저장 완료 후, 필요에 따라 메인 화면(노트 목록)으로 자동 전환되거나, '저장 완료' 메시지를 잠시 표시합니다.

### 1.5. 데이터 모델 영향
*   **생성:** `notes` 테이블에 새로운 레코드(노트 객체)가 삽입됩니다. `id`, `title`, `content`, `created_at`, `updated_at`, `user_id`, `local_only` 등의 필드가 채워집니다.
*   **수정:** `notes` 테이블의 기존 레코드(`id` 기준)의 `title`, `content`, `updated_at` 필드가 갱신됩니다.

### 1.6. 오류 처리
*   **저장 실패:** 로컬 저장 공간 부족, 데이터베이스 오류 등으로 저장에 실패할 경우, 사용자에게 '저장 실패' 메시지를 표시하고 재시도 옵션을 제공합니다. (공통 오류 처리 규칙 참조)
*   **동기화 실패:** 네트워크 문제 등으로 클라우드 동기화에 실패할 경우, 사용자에게 알림을 제공하고 나중에 다시 시도할 수 있도록 합니다. (공통 오류 처리 규칙 참조)

### 1.7. 사전/사후 조건
*   **사전 조건:** 앱이 실행 중이어야 합니다.
*   **사후 조건:** 새로운 노트가 생성되어 로컬 데이터베이스에 저장되고, `notes` 테이블에 새로운 레코드가 추가되며, `created_at` 및 `updated_at` 필드가 현재 시각으로 설정됩니다. 회원/프리미엄 구독자의 경우 클라우드에 동기화됩니다.

## 2. 노트 수정 기능

### 2.1. 개요
기존에 생성된 노트를 선택하여 내용을 수정하고 저장하는 기능을 제공합니다. 비회원, 회원, 프리미엄 구독자 모두에게 제공되는 공통 기능입니다.

### 2.2. 사용자 인터페이스 (UI)
*   **노트 목록 화면:** 각 노트 항목은 탭하여 편집 화면으로 진입할 수 있도록 구성됩니다.
*   **노트 편집 화면:** 노트 생성 기능과 동일한 UI 요소를 사용합니다. (UI/UX 설계 문서에서 와이어프레임/스케치 연결)

### 2.3. 사용자 상호작용
1.  **노트 선택:** 사용자가 노트 목록 화면에서 수정하고자 하는 노트를 탭합니다.
2.  **노트 편집 화면 진입:** 앱은 선택된 노트의 내용을 로드하여 편집 화면으로 전환됩니다.
3.  **내용 수정:** 사용자가 노트 제목 또는 내용을 수정합니다.
4.  **서식 적용:** 사용자가 텍스트를 선택하고 하단 도구 모음에서 원하는 서식 버튼을 탭하여 적용합니다.
5.  **저장:**
    *   **자동 저장:** 사용자가 편집 화면을 벗어나거나, **5초마다**, 또는 **포커스 아웃 시점**에 자동으로 노트가 저장됩니다.
    *   **수동 저장 (선택 사항):** 사용자가 '저장' 버튼을 탭하여 명시적으로 저장할 수 있습니다.

### 2.4. 시스템 응답
1.  **노트 선택 시:**
    *   앱은 로컬 데이터베이스에서 해당 노트의 데이터를 로드합니다.
    *   로드된 노트 내용이 편집 화면에 표시됩니다.
2.  **내용 수정 및 서식 적용 시:**
    *   수정된 텍스트와 적용된 서식이 실시간으로 화면에 반영됩니다.
3.  **저장 시:**
    *   로컬 데이터베이스에 해당 노트의 최신 내용이 업데이트됩니다.
    *   **회원/프리미엄 구독자:** 백그라운드에서 Supabase 클라우드 데이터베이스로 동기화 요청이 전송됩니다.
        *   **동기화 실패 시:** 최대 3회 재시도 (백오프 정책 적용), 이후 사용자에게 알림 제공 및 수동 동기화 옵션 제공.
    *   **비회원:** 로컬에만 저장됩니다.
    *   저장 완료 후, 필요에 따라 메인 화면(노트 목록)으로 자동 전환되거나, '저장 완료' 메시지를 잠시 표시합니다.

### 2.5. 데이터 모델 영향
*   **수정:** `notes` 테이블의 기존 레코드(`id` 기준)의 `title`, `content`, `updated_at` 필드가 갱신됩니다.

### 2.6. 오류 처리
*   **저장 실패:** 로컬 저장 공간 부족, 데이터베이스 오류 등으로 저장에 실패할 경우, 사용자에게 '저장 실패' 메시지를 표시하고 재시도 옵션을 제공합니다. (공통 오류 처리 규칙 참조)
*   **동기화 실패:** 네트워크 문제 등으로 클라우드 동기화에 실패할 경우, 사용자에게 알림을 제공하고 나중에 다시 시도할 수 있도록 합니다. (공통 오류 처리 규칙 참조)

### 2.7. 사전/사후 조건
*   **사전 조건:** 수정하고자 하는 노트가 존재해야 합니다.
*   **사후 조건:** 선택된 노트의 내용이 로컬 데이터베이스에 업데이트되고, `notes` 테이블의 해당 레코드의 `updated_at` 필드가 현재 시각으로 갱신됩니다. 회원/프리미엄 구독자의 경우 클라우드에 동기화됩니다.

## 3. 노트 삭제 기능

### 3.1. 개요
사용자가 기존 노트를 삭제하는 기능을 제공합니다. 삭제 방식은 소프트 삭제와 완전 삭제를 포함하며, 삭제 후 동기화 정책을 따릅니다. 비회원, 회원, 프리미엄 구독자 모두에게 제공되는 공통 기능입니다.

### 3.2. 사용자 인터페이스 (UI)
*   **노트 목록 화면:**
    *   각 노트 항목에 '삭제' 아이콘 (예: 휴지통 아이콘) 또는 길게 눌렀을 때 나타나는 컨텍스트 메뉴에 '삭제' 옵션.
    *   다중 선택 모드 진입 시 하단 또는 상단에 '선택 삭제' 버튼.
*   **노트 상세 화면:** 상단 또는 하단에 '삭제' 버튼.
*   **삭제 확인 팝업/모달:**
    *   "노트를 삭제하시겠습니까?" 메시지.
    *   '취소' 버튼, '삭제' 버튼.
    *   (선택 사항) '완전히 삭제' 옵션 체크박스 (프리미엄 사용자 또는 특정 조건 시 활성화).

### 3.3. 사용자 상호작용
1.  **삭제 요청:**
    *   사용자가 노트 목록에서 특정 노트의 '삭제' 아이콘을 탭하거나, 컨텍스트 메뉴에서 '삭제'를 선택합니다.
    *   또는 노트 상세 화면에서 '삭제' 버튼을 탭합니다.
2.  **삭제 확인:** 앱은 사용자에게 '노트를 삭제하시겠습니까?'라는 확인 팝업/모달을 표시합니다.
3.  **삭제 실행:** 사용자가 확인 팝업에서 '삭제' 버튼을 탭합니다.
    *   (선택 사항) '완전히 삭제' 옵션을 선택한 경우, 해당 옵션이 적용됩니다.
4.  **삭제 취소:** 사용자가 확인 팝업에서 '취소' 버튼을 탭합니다.

### 3.4. 시스템 응답
1.  **삭제 요청 시:**
    *   앱은 해당 노트의 `is_deleted` 필드를 `TRUE`로 업데이트하고, `updated_at` 필드를 현재 시각으로 갱신하여 로컬 DB에 저장합니다. (소프트 삭제)
    *   노트 목록에서 해당 노트를 즉시 제거합니다.
2.  **동기화 정책:**
    *   **회원/프리미엄 구독자:** 백그라운드에서 Supabase 클라우드 데이터베이스로 삭제 동기화 요청이 전송됩니다.
        *   클라우드 DB에서도 해당 노트의 `is_deleted` 필드를 `TRUE`로 업데이트합니다.
        *   (완전 삭제 요청 시) 클라우드 DB에서도 해당 노트를 물리적으로 삭제합니다.
    *   **비회원:** 로컬 DB에서만 `is_deleted` 필드를 업데이트하거나 물리적으로 삭제합니다.
3.  **삭제 완료:** 사용자에게 '노트가 삭제되었습니다.'와 같은 메시지를 잠시 표시합니다.

### 3.5. 데이터 모델 영향
*   **소프트 삭제:** `notes` 테이블의 해당 레코드(`id` 기준)의 `is_deleted` 필드가 `FALSE`에서 `TRUE`로 갱신되고, `updated_at` 필드가 현재 시각으로 갱신됩니다.
*   **완전 삭제:** `notes` 테이블의 해당 레코드가 물리적으로 삭제됩니다.

### 3.6. 오류 처리
*   **삭제 실패:** 데이터베이스 오류 등으로 삭제에 실패할 경우, 사용자에게 '삭제 실패' 메시지를 표시합니다. (공통 오류 처리 규칙 참조)
*   **동기화 실패:** 네트워크 문제 등으로 클라우드 동기화에 실패할 경우, 사용자에게 알림을 제공하고 나중에 다시 시도할 수 있도록 합니다. (공통 오류 처리 규칙 참조)

### 3.7. 사전/사후 조건
*   **사전 조건:** 삭제하고자 하는 노트가 존재해야 합니다.
*   **사후 조건:**
    *   노트가 로컬 데이터베이스에서 소프트 삭제되거나 물리적으로 삭제됩니다.
    *   `notes` 테이블의 해당 레코드의 `is_deleted` 필드가 `TRUE`로 설정되거나 레코드가 삭제됩니다.
    *   회원/프리미엄 구독자의 경우 클라우드에 삭제 상태가 동기화됩니다.

## 4. 노트 목록/검색 기능

### 4.1. 개요
사용자가 생성된 노트들을 목록 형태로 확인하고, 필터링, 정렬, 검색 기능을 통해 원하는 노트를 효율적으로 찾을 수 있도록 합니다. 비회원, 회원, 프리미엄 구독자 모두에게 제공되는 공통 기능입니다.

### 4.2. 사용자 인터페이스 (UI)
*   **노트 목록 화면:**
    *   상단: 앱 제목/로고, 검색 아이콘/검색 바, 정렬/필터 아이콘.
    *   중앙: 노트 목록 (제목, 미리보기 텍스트, 최종 수정일 등 표시).
    *   하단: '새 노트 생성' 버튼.
*   **검색 화면:**
    *   상단: 검색 입력 필드, '취소' 버튼.
    *   중앙: 검색 결과 목록.
*   **필터/정렬 팝업/모달:**
    *   정렬 옵션: 최신순, 제목순, 수정일순 등.
    *   필터 옵션: 프로젝트별, 태그별 (프리미엄), 즐겨찾기 등.

### 4.3. 사용자 상호작용
1.  **노트 목록 보기:** 앱 실행 시 또는 메인 화면 진입 시 노트 목록이 자동으로 표시됩니다.
2.  **노트 스크롤:** 사용자가 목록을 위아래로 스크롤하여 노트를 탐색합니다.
3.  **검색 시작:** 사용자가 검색 아이콘을 탭하거나 검색 바를 활성화합니다.
4.  **검색어 입력:** 사용자가 검색 필드에 검색어를 입력합니다.
5.  **검색 결과 확인:** 입력된 검색어에 따라 실시간으로 검색 결과가 업데이트되어 표시됩니다.
6.  **필터/정렬 적용:** 사용자가 필터/정렬 아이콘을 탭하고 원하는 옵션을 선택하여 목록을 재정렬하거나 필터링합니다.

### 4.4. 시스템 응답
1.  **노트 목록 로드 시:**
    *   로컬 DB에서 노트 데이터를 로드하여 목록 형태로 표시합니다.
    *   회원/프리미엄 구독자의 경우, 클라우드 동기화 상태를 확인하여 최신 데이터를 반영합니다.
2.  **검색어 입력 시:**
    *   입력된 검색어를 포함하는 노트의 제목 또는 본문 내용을 로컬 DB에서 검색합니다.
    *   검색 결과는 실시간으로 UI에 반영됩니다.
    *   (프리미엄) 클라우드 DB에서도 검색을 수행하여 더 넓은 범위의 결과를 제공할 수 있습니다.
3.  **필터/정렬 옵션 선택 시:**
    *   선택된 기준에 따라 로컬 DB에서 가져온 노트 목록을 재정렬하거나 필터링하여 UI에 표시합니다.

### 4.5. 데이터 모델 영향
*   **읽기:** `notes` 테이블에서 데이터를 조회합니다. 검색 시 `title` 및 `content` 필드를 활용합니다. 필터링 시 `project_id`, `created_at`, `updated_at` 등의 필드를 활용합니다.

### 4.6. 오류 처리
*   **검색 결과 없음:** 검색 결과가 없을 경우, 사용자에게 '검색 결과가 없습니다.' 메시지를 표시합니다. (공통 오류 처리 규칙 참조)
*   **데이터 로드 실패:** 네트워크 문제 또는 DB 오류로 노트 목록 로드에 실패할 경우, 사용자에게 알림을 제공합니다. (공통 오류 처리 규칙 참조)

### 4.7. 사전/사후 조건
*   **사전 조건:** 노트가 하나 이상 존재해야 합니다.
*   **사후 조건:** 사용자가 원하는 조건에 따라 필터링되고 정렬된 노트 목록이 화면에 표시됩니다.

## 5. 프로젝트/조직 관리 기능

### 5.1. 프로젝트 생성/수정/삭제

#### 5.1.1. 개요
사용자가 새로운 프로젝트를 생성하고, 기존 프로젝트의 정보를 수정하거나 삭제하는 기능을 제공합니다. 회원(제한적) 및 프리미엄 구독자에게 제공됩니다.

#### 5.1.2. 사용자 인터페이스 (UI)
*   **프로젝트 목록 화면:**
    *   상단: '새 프로젝트 생성' 버튼 (예: '+' 아이콘).
    *   중앙: 프로젝트 목록 (프로젝트명, 소유자, 멤버 수 등 표시).
    *   각 프로젝트 항목: 탭하여 상세 화면 진입, 길게 눌러 컨텍스트 메뉴 (수정, 삭제 등).
*   **프로젝트 생성/수정 화면:**
    *   상단: '뒤로 가기' 버튼, '저장' 버튼.
    *   중앙: 프로젝트명 입력 필드, 설명 입력 필드, 공개 범위 설정 (private, team, public) 옵션.
*   **삭제 확인 팝업/모달:**
    *   "프로젝트를 삭제하시겠습니까?" 메시지.
    *   '취소' 버튼, '삭제' 버튼.

#### 5.1.3. 사용자 상호작용
1.  **프로젝트 생성:** 사용자가 프로젝트 목록 화면에서 '새 프로젝트 생성' 버튼을 탭합니다.
2.  **정보 입력:** 프로젝트 생성 화면에서 프로젝트명, 설명, 공개 범위 등을 입력합니다.
3.  **저장:** 사용자가 '저장' 버튼을 탭하여 프로젝트를 생성합니다.
4.  **프로젝트 수정:** 프로젝트 목록에서 수정할 프로젝트를 선택하고, 수정 화면에서 정보를 변경 후 저장합니다.
5.  **프로젝트 삭제:** 프로젝트 목록에서 삭제할 프로젝트를 선택하고, 컨텍스트 메뉴 또는 상세 화면에서 '삭제'를 선택합니다. 확인 팝업에서 '삭제'를 최종 확인합니다.

#### 5.1.4. 시스템 응답
1.  **프로젝트 생성 시:**
    *   앱은 새로운 프로젝트 객체를 생성하고, 고유 ID를 할당합니다.
    *   로컬 DB 및 Supabase DB에 프로젝트 정보를 저장합니다.
    *   회원(무료)의 경우, 정책에 따른 프로젝트 개수 제한을 초과하면 생성 불가 알림을 제공합니다.
2.  **프로젝트 수정 시:**
    *   로컬 DB 및 Supabase DB에 변경된 프로젝트 정보를 업데이트합니다.
3.  **프로젝트 삭제 시:**
    *   로컬 DB 및 Supabase DB에서 해당 프로젝트를 삭제합니다 (소프트 삭제 또는 물리적 삭제 정책에 따름).
    *   프로젝트에 속한 노트들의 `project_id`를 NULL로 설정하거나 함께 삭제합니다 (정책에 따름).

#### 5.1.5. 데이터 모델 영향
*   **생성:** `projects` 테이블에 새로운 레코드가 삽입됩니다. `id`, `owner_id`, `name`, `description`, `visibility`, `created_at`, `updated_at` 필드가 채워집니다.
*   **수정:** `projects` 테이블의 기존 레코드(`id` 기준)의 `name`, `description`, `visibility`, `updated_at` 필드가 갱신됩니다.
*   **삭제:** `projects` 테이블의 해당 레코드가 삭제되거나 `is_deleted` 필드가 갱신됩니다. `notes` 테이블의 `project_id` 필드에 영향을 줄 수 있습니다.

#### 5.1.6. 오류 처리
*   **생성/수정/삭제 실패:** 네트워크 오류, 권한 없음, DB 오류 등으로 작업에 실패할 경우, 사용자에게 알림을 제공합니다. (공통 오류 처리 규칙 참조)
*   **제한 초과:** 무료 회원이 프로젝트 생성 제한을 초과하려 할 경우, 알림을 제공하고 프리미엄 전환을 유도합니다.

#### 5.1.7. 사전/사후 조건
*   **사전 조건:**
    *   생성: 사용자가 로그인 상태여야 합니다.
    *   수정/삭제: 해당 프로젝트가 존재하고, 사용자에게 수정/삭제 권한이 있어야 합니다.
*   **사후 조건:**
    *   생성: 새로운 프로젝트가 생성되어 DB에 저장됩니다.
    *   수정: 프로젝트 정보가 DB에 업데이트됩니다.
    *   삭제: 프로젝트가 DB에서 삭제되거나 비활성화됩니다.

### 5.2. 프로젝트 멤버 관리 (초대/권한 설정)

#### 5.2.1. 개요
프로젝트 소유자가 다른 사용자를 프로젝트에 초대하고, 초대된 멤버의 역할을 설정(viewer, editor, admin)하는 기능을 제공합니다. 프리미엄 구독자에게 제공되는 기능입니다.

#### 5.2.2. 사용자 인터페이스 (UI)
*   **프로젝트 상세 화면:** '멤버 관리' 또는 '멤버 초대' 버튼.
*   **멤버 관리 화면:**
    *   현재 멤버 목록 (멤버명, 역할 표시).
    *   '멤버 초대' 버튼.
    *   각 멤버 항목: 역할 변경 옵션, '멤버 제거' 버튼.
*   **멤버 초대 팝업/모달:**
    *   초대할 사용자 이메일 입력 필드.
    *   역할 선택 드롭다운 (viewer, editor, admin).
    *   '초대 보내기' 버튼.

#### 5.2.3. 사용자 상호작용
1.  **멤버 관리 진입:** 프로젝트 상세 화면에서 '멤버 관리' 버튼을 탭합니다.
2.  **멤버 초대:** 멤버 관리 화면에서 '멤버 초대' 버튼을 탭합니다.
3.  **초대 정보 입력:** 초대할 사용자의 이메일과 역할을 입력하고 '초대 보내기'를 탭합니다.
4.  **역할 변경:** 기존 멤버의 역할 옆에 있는 옵션을 탭하여 새로운 역할을 선택합니다.
5.  **멤버 제거:** 멤버 목록에서 제거할 멤버 옆의 '멤버 제거' 버튼을 탭합니다.

#### 5.2.4. 시스템 응답
1.  **멤버 초대 시:**
    *   입력된 이메일로 초대 알림을 발송합니다.
    *   `project_members` 테이블에 새로운 레코드를 생성합니다 (초대 상태로).
    *   초대받은 사용자가 수락 시 `project_members` 테이블의 상태를 업데이트하고, 해당 프로젝트에 접근 권한을 부여합니다.
2.  **역할 변경 시:**
    *   `project_members` 테이블에서 해당 멤버의 `role` 필드를 업데이트합니다.
    *   변경 사항은 즉시 적용되어 해당 멤버의 프로젝트 접근 권한에 영향을 미칩니다.

#### 5.2.5. 데이터 모델 영향
*   **생성:** `project_members` 테이블에 새로운 레코드가 삽입됩니다. `project_id`, `user_id`, `role` 필드가 채워집니다.
*   **수정:** `project_members` 테이블의 기존 레코드(`project_id`, `user_id` 기준)의 `role` 필드가 갱신됩니다.
*   **삭제:** `project_members` 테이블의 해당 레코드가 삭제됩니다.

#### 5.2.6. 오류 처리
*   **초대 실패:** 유효하지 않은 이메일, 이미 초대된 사용자, 권한 부족 등으로 초대에 실패할 경우, 알림을 제공합니다. (공통 오류 처리 규칙 참조)
*   **역할 변경/제거 실패:** 권한 부족, 네트워크 오류 등으로 작업에 실패할 경우, 알림을 제공합니다. (공통 오류 처리 규칙 참조)

#### 5.2.7. 사전/사후 조건
*   **사전 조건:**
    *   프로젝트가 존재해야 합니다.
    *   사용자에게 멤버 관리 권한(admin)이 있어야 합니다.
*   **사후 조건:**
    *   멤버 초대 시: 해당 사용자가 프로젝트에 초대되거나, 역할이 변경되거나, 프로젝트에서 제거됩니다.
    *   `project_members` 테이블의 상태가 업데이트됩니다.

### 5.3. 공유 프로젝트 접근 권한 제어

#### 5.3.1. 개요
프로젝트의 `visibility` 설정(`private`, `team`, `public`)과 Supabase RLS를 활용하여 사용자가 공유된 프로젝트에 접근할 수 있는 권한을 제어합니다. 프리미엄 구독자에게 제공되는 기능입니다.

#### 5.3.2. 사용자 인터페이스 (UI)
*   **프로젝트 생성/수정 화면:** '공개 범위' 설정 드롭다운 또는 라디오 버튼 (private, team, public).
*   **프로젝트 목록/상세 화면:** 각 프로젝트의 현재 공개 범위 표시.

#### 5.3.3. 사용자 상호작용
1.  **공개 범위 설정:** 프로젝트 생성 또는 수정 시, 사용자가 프로젝트의 공개 범위를 선택합니다.
    *   `private`: 프로젝트 소유자 및 명시적으로 초대된 멤버만 접근 가능.
    *   `team`: 동일 조직/팀에 속한 모든 멤버가 접근 가능 (조직/팀 개념이 도입될 경우).
    *   `public`: 링크를 아는 모든 사용자 또는 앱 내에서 검색 가능한 모든 사용자가 접근 가능 (읽기 전용).

#### 5.3.4. 시스템 응답
1.  **공개 범위 설정 시:**
    *   `projects` 테이블의 `visibility` 필드가 업데이트됩니다.
    *   Supabase RLS 정책이 해당 `visibility` 설정에 따라 접근 권한을 동적으로 제어합니다.
    *   `private` 프로젝트의 경우, `project_members` 테이블에 명시된 사용자만 접근을 허용합니다.
    *   `public` 프로젝트의 경우, 인증되지 않은 사용자도 읽기 접근을 허용할 수 있습니다.

#### 5.3.5. 데이터 모델 영향
*   **수정:** `projects` 테이블의 `visibility` 필드가 갱신됩니다.

#### 5.3.6. 오류 처리
*   **권한 부족:** 공개 범위 변경 권한이 없는 사용자가 변경을 시도할 경우, 알림을 제공하고 작업을 거부합니다. (공통 오류 처리 규칙 참조)

#### 5.3.7. 사전/사후 조건
*   **사전 조건:** 프로젝트가 존재하고, 사용자에게 공개 범위 변경 권한이 있어야 합니다.
*   **사후 조건:** 프로젝트의 `visibility` 설정이 변경되고, 해당 설정에 따라 사용자들의 접근 권한이 제어됩니다.

### 5.4. 프로젝트별 노트 목록

#### 5.4.1. 개요
사용자가 특정 프로젝트에 속한 노트들만 별도로 모아 볼 수 있도록 하는 기능을 제공합니다. 프로젝트를 통해 노트를 체계적으로 관리하고 탐색하는 데 도움을 줍니다. 회원 및 프리미엄 구독자에게 제공됩니다.

#### 5.4.2. 사용자 인터페이스 (UI)
*   **프로젝트 상세 화면:** 해당 프로젝트에 속한 노트들의 목록을 표시하는 섹션.
*   **노트 목록 화면:** 필터 옵션에 '프로젝트별' 필터 추가.
*   **노트 생성 화면:** 새 노트 생성 시, 어떤 프로젝트에 속할지 선택하는 옵션.

#### 5.4.3. 사용자 상호작용
1.  **프로젝트별 노트 보기:** 사용자가 프로젝트 목록에서 특정 프로젝트를 선택하거나, 프로젝트 상세 화면으로 진입하여 해당 프로젝트에 속한 노트 목록을 확인합니다.
2.  **노트 생성 시 프로젝트 지정:** 새 노트를 생성할 때, 사용자가 해당 노트를 특정 프로젝트에 할당할 수 있습니다.
3.  **노트 이동:** 기존 노트를 다른 프로젝트로 이동시키거나, 프로젝트에서 제거하여 개인 노트로 만들 수 있습니다.

#### 5.4.4. 시스템 응답
1.  **프로젝트별 노트 목록 요청 시:**
    *   `notes` 테이블에서 해당 `project_id`를 가진 노트들을 조회하여 목록으로 반환합니다.
    *   사용자의 접근 권한(RLS)에 따라 접근 가능한 노트만 표시합니다.
2.  **노트 생성 시 프로젝트 지정:**
    *   새 노트 생성 시 `notes` 테이블의 `project_id` 필드에 선택된 프로젝트의 ID를 할당합니다.
3.  **노트 이동 시:**
    *   `notes` 테이블에서 해당 노트의 `project_id` 필드를 변경합니다 (다른 프로젝트 ID 또는 NULL).

#### 5.4.5. 데이터 모델 영향
*   **읽기:** `notes` 테이블에서 `project_id` 필드를 기준으로 데이터를 조회합니다.
*   **생성/수정:** `notes` 테이블의 `project_id` 필드가 설정되거나 변경됩니다.

#### 5.4.6. 오류 처리
*   **권한 부족:** 접근 권한이 없는 프로젝트의 노트를 조회하려 할 경우, 알림을 제공하고 접근을 거부합니다. (공통 오류 처리 규칙 참조)

#### 5.4.7. 사전/사후 조건
*   **사전 조건:** 프로젝트가 존재하고, 해당 프로젝트에 노트가 할당되어 있어야 합니다.
*   **사후 조건:** 사용자가 선택한 프로젝트에 속한 노트 목록이 화면에 표시됩니다.

## 6. 협업 기능

### 6.1. 댓글 및 제안 모드 (무료 회원 제한)

#### 6.1.1. 개요
사용자가 공유된 노트나 프로젝트에 직접 편집 권한 없이 댓글을 남기거나, 내용에 대한 제안을 할 수 있는 기능을 제공합니다. 무료 회원에게 제공되는 제한된 협업 기능입니다.

#### 6.1.2. 사용자 인터페이스 (UI)
*   **노트/프로젝트 상세 화면:**
    *   댓글 섹션: 기존 댓글 목록, 새 댓글 입력 필드, '댓글 작성' 버튼.
    *   제안 모드 활성화 버튼 (선택 사항).
    *   제안된 내용 표시 (원문과 제안 내용 비교).

#### 6.1.3. 사용자 상호작용
1.  **댓글 작성:** 사용자가 노트 또는 프로젝트 상세 화면의 댓글 섹션에서 댓글을 입력하고 '댓글 작성' 버튼을 탭합니다.
2.  **제안하기:** (선택 사항) 사용자가 제안 모드를 활성화하고 노트 내용의 특정 부분에 대해 변경을 제안합니다.

#### 6.1.4. 시스템 응답
1.  **댓글 작성 시:**
    *   `comments` 테이블 (새로운 테이블 필요)에 댓글 내용을 저장합니다.
    *   실시간으로 다른 사용자들에게 댓글이 표시됩니다.
2.  **제안하기 시:**
    *   `suggestions` 테이블 (새로운 테이블 필요)에 원문과 제안 내용을 저장합니다.
    *   프로젝트 소유자 또는 편집 권한자에게 제안 알림을 보냅니다.

#### 6.1.5. 데이터 모델 영향
*   **생성:** `comments` 테이블 (id, note_id/project_id, user_id, content, created_at) 및 `suggestions` 테이블 (id, note_id, user_id, original_content, suggested_content, status, created_at)이 추가될 수 있습니다.

#### 6.1.6. 오류 처리
*   **작성 실패:** 네트워크 오류, 권한 부족 등으로 댓글/제안 작성에 실패할 경우, 사용자에게 알림을 제공합니다. (공통 오류 처리 규칙 참조)

#### 6.1.7. 사전/사후 조건
*   **사전 조건:** 사용자가 로그인 상태여야 하며, 해당 노트/프로젝트에 접근 권한이 있어야 합니다.
*   **사후 조건:** 댓글 또는 제안이 해당 노트/프로젝트에 추가되고, 관련 사용자들에게 표시됩니다.

### 6.2. 실시간 공동 편집 (프리미엄 전용)

#### 6.2.1. 개요
프리미엄 구독자가 공유된 노트를 여러 사용자와 동시에 편집하고, 변경 사항이 실시간으로 반영되는 기능을 제공합니다. Supabase Realtime 기능과 데이터 모델의 블록 기반 구조를 활용하여 충돌을 최소화합니다.

#### 6.2.2. 사용자 인터페이스 (UI)
*   **노트 편집 화면:**
    *   공동 편집 중인 다른 사용자들의 커서 위치 또는 아바타 표시.
    *   다른 사용자의 실시간 입력 내용 표시.
    *   (선택 사항) 공동 편집 참여자 목록.

#### 6.2.3. 사용자 상호작용
1.  **공동 편집 시작:** 프리미엄 구독자가 공동 편집이 가능한 노트를 열면 자동으로 공동 편집 모드로 진입합니다.
2.  **실시간 편집:** 여러 사용자가 동시에 노트 내용을 입력, 수정, 삭제합니다.
3.  **변경 사항 확인:** 다른 사용자의 변경 사항이 자신의 화면에 실시간으로 반영되는 것을 확인합니다.

#### 6.2.4. 시스템 응답
1.  **편집 내용 전송:** 사용자의 입력 내용이 발생할 때마다 작은 단위의 변경(예: 문자 단위, 블록 단위)이 Supabase Realtime 채널을 통해 서버로 전송됩니다.
2.  **변경 사항 브로드캐스트:** Supabase Realtime 서버는 수신된 변경 사항을 해당 노트에 참여 중인 모든 클라이언트에게 브로드캐스트합니다.
3.  **클라이언트 반영:** 각 클라이언트는 수신된 변경 사항을 자신의 로컬 노트 데이터에 적용하고 UI를 업데이트합니다.
4.  **충돌 해결:** 블록 기반 구조와 Last Writer Wins 또는 더 정교한 충돌 해결 전략(OT/CRDT)을 통해 동시 편집 시 발생할 수 있는 충돌을 처리합니다.

#### 6.2.5. 데이터 모델 영향
*   **수정:** `notes` 테이블의 `content` 필드(JSONB)가 실시간으로 업데이트됩니다. 각 블록의 고유 ID와 버전 관리가 필요할 수 있습니다.

#### 6.2.6. 오류 처리
*   **연결 끊김:** 네트워크 연결이 끊길 경우, 사용자에게 알림을 제공하고 재연결을 시도합니다. (공통 오류 처리 규칙 참조)
*   **동기화 지연:** 네트워크 지연으로 인해 변경 사항 반영이 늦어질 경우, 시각적인 피드백(예: 로딩 인디케이터)을 제공합니다.
*   **충돌 발생:** 충돌 발생 시 사용자에게 알림을 제공하고, 시스템이 정의한 충돌 해결 정책에 따라 처리합니다. (공통 오류 처리 규칙 참조)

#### 6.2.7. 사전/사후 조건
*   **사전 조건:**
    *   사용자가 프리미엄 구독자여야 합니다.
    *   노트가 공유되어 있고, 다른 공동 편집자가 접속 중이어야 합니다.
    *   네트워크 연결이 안정적이어야 합니다.
*   **사후 조건:** 여러 사용자가 동시에 노트를 편집하고, 변경 사항이 실시간으로 모든 참여자에게 반영됩니다.

### 6.3. 변경 내역 및 버전 관리

#### 6.3.1. 개요
노트의 변경 이력을 기록하고, 특정 시점의 버전으로 되돌릴 수 있는 기능을 제공합니다. 공동 편집 환경에서 변경 사항 추적 및 복구에 유용합니다. 프리미엄 구독자에게 제공되는 기능입니다.

#### 6.3.2. 사용자 인터페이스 (UI)
*   **노트 편집 화면 또는 상세 화면:** '변경 내역' 또는 '버전 기록' 버튼/메뉴.
*   **버전 기록 화면:**
    *   시간대별 변경 이력 목록 (변경자, 변경 시간, 간략한 변경 내용 표시).
    *   각 이력 항목: '미리보기', '이 버전으로 되돌리기' 버튼.
    *   (선택 사항) 두 버전 간의 차이점(Diff) 표시.

#### 6.3.3. 사용자 상호작용
1.  **버전 기록 접근:** 사용자가 노트 편집 화면 또는 상세 화면에서 '변경 내역' 또는 '버전 기록' 버튼을 탭합니다.
2.  **이력 확인:** 버전 기록 화면에서 시간대별 변경 이력 목록을 확인합니다.
3.  **버전 미리보기:** 특정 이력 항목을 선택하여 해당 시점의 노트 내용을 미리 봅니다.
4.  **버전 되돌리기:** 원하는 이력 항목을 선택하고 '이 버전으로 되돌리기' 버튼을 탭하여 노트를 해당 시점으로 복원합니다.

#### 6.3.4. 시스템 응답
1.  **변경 이력 기록:** 노트 내용이 저장될 때마다 (자동 저장 또는 수동 저장 시) 이전 버전의 스냅샷을 별도의 `note_versions` 테이블에 저장합니다.
    *   변경이 너무 잦을 경우, 일정 시간 간격 또는 주요 변경 시점에만 스냅샷을 생성하는 정책을 적용합니다.
2.  **버전 기록 요청 시:**
    *   `note_versions` 테이블에서 해당 노트의 변경 이력을 조회하여 시간 역순으로 반환합니다.
3.  **버전 되돌리기 요청 시:**
    *   선택된 버전의 내용을 현재 노트의 `content` 필드에 복원하고, `updated_at` 필드를 갱신합니다.
    *   복원된 내용은 로컬 DB 및 Supabase DB에 동기화됩니다.

#### 6.3.5. 데이터 모델 영향
*   **생성:** `note_versions` 테이블 (id, note_id, version_content, changed_by_user_id, created_at)이 추가됩니다.
*   **수정:** 노트 되돌리기 시 `notes` 테이블의 `content` 및 `updated_at` 필드가 갱신됩니다.

#### 6.3.6. 오류 처리
*   **버전 로드 실패:** 네트워크 오류 또는 DB 오류로 버전 기록 로드에 실패할 경우, 사용자에게 알림을 제공합니다. (공통 오류 처리 규칙 참조)
*   **되돌리기 실패:** 데이터베이스 오류 등으로 되돌리기에 실패할 경우, 사용자에게 알림을 제공합니다. (공통 오류 처리 규칙 참조)

#### 6.3.7. 사전/사후 조건
*   **사전 조건:**
    *   사용자가 프리미엄 구독자여야 합니다.
    *   노트가 존재하고, 변경 이력이 기록되어 있어야 합니다.
*   **사후 조건:**
    *   노트의 변경 이력을 확인할 수 있습니다.
    *   노트가 특정 시점의 버전으로 복원됩니다.

## 7. AI 관련 기능

### 7.1. AI 사전 (단어/문구 조회)

#### 7.1.1. 개요
사용자가 노트 내용 중 특정 단어나 문구를 선택하면, AI 기반의 사전 기능을 통해 해당 단어/문구에 대한 정의, 관련 정보 등을 조회할 수 있습니다. 무료 회원에게는 제한된 사용량이 제공됩니다.

#### 7.1.2. 사용자 인터페이스 (UI)
*   **노트 편집/보기 화면:**
    *   텍스트 선택 시 나타나는 컨텍스트 메뉴에 'AI 사전' 옵션.
    *   'AI 사전' 옵션 선택 시 화면 하단 또는 팝업 형태로 사전 결과 표시 영역.

#### 7.1.3. 사용자 상호작용
1.  **단어/문구 선택:** 사용자가 노트 내용 중 궁금한 단어나 문구를 길게 눌러 선택합니다.
2.  **AI 사전 호출:** 선택된 텍스트에 대해 나타나는 컨텍스트 메뉴에서 'AI 사전' 옵션을 탭합니다.
3.  **결과 확인:** 앱은 AI 사전 조회 결과를 화면에 표시합니다.

#### 7.1.4. 시스템 응답
1.  **조회 요청 시:**
    *   선택된 단어/문구를 Supabase Edge Function으로 전송합니다.
    *   Edge Function은 사용자의 AI 사용량 제한을 확인하고, 제한을 초과하지 않은 경우 외부 LLM API에 조회 요청을 보냅니다.
    *   LLM API로부터 받은 결과를 Flutter 앱으로 반환합니다.
2.  **결과 표시:** 앱은 반환된 사전 결과를 파싱하여 사용자에게 보기 좋은 형태로 표시합니다.
3.  **사용량 차감:** 무료 회원의 경우, 조회 성공 시 AI 사용량 카운트를 차감합니다.
4.  **제한 초과 시:** 무료 회원이 사용량 제한을 초과할 경우, '사용량 초과' 메시지를 표시하고 프리미엄 전환을 유도합니다.

#### 7.1.5. 데이터 모델 영향
*   **읽기:** AI 사전 조회를 위해 노트 내용의 일부를 읽습니다.
*   **수정:** 사용자별 AI 사용량 카운트(`users` 테이블 또는 별도 `ai_usage` 테이블)가 갱신될 수 있습니다.

#### 7.1.6. 오류 처리
*   **네트워크 오류:** AI 사전 조회 중 네트워크 연결 문제 발생 시 알림을 제공합니다. (공통 오류 처리 규칙 참조)
*   **API 오류:** 외부 LLM API 또는 Edge Function에서 오류 발생 시 사용자에게 알림을 제공합니다. (공통 오류 처리 규칙 참조)
*   **사용량 제한:** 사용량 제한 초과 시 적절한 메시지를 표시합니다. (공통 오류 처리 규칙 참조)

#### 7.1.7. 사전/사후 조건
*   **사전 조건:**
    *   노트가 존재하고, 텍스트 내용이 있어야 합니다.
    *   네트워크 연결이 되어 있어야 합니다.
    *   무료 회원의 경우 AI 사용량 제한을 초과하지 않아야 합니다.
*   **사후 조건:** 선택된 단어/문구에 대한 AI 사전 조회 결과가 화면에 표시됩니다.

### 7.2. AI 요약 (노트 전체 요약)

#### 7.2.1. 개요
노트의 전체 내용을 AI가 분석하여 핵심 내용을 요약해주는 기능을 제공합니다. 프리미엄 구독자에게 제공되는 고급 AI 기능입니다.

#### 7.2.2. 사용자 인터페이스 (UI)
*   **노트 상세 화면:** 'AI 요약' 버튼 또는 메뉴 옵션.
*   **요약 결과 표시:** 노트 내용 상단 또는 별도의 팝업/모달 형태로 요약된 텍스트 표시.

#### 7.2.3. 사용자 상호작용
1.  **AI 요약 요청:** 사용자가 노트 상세 화면에서 'AI 요약' 버튼 또는 메뉴 옵션을 탭합니다.
2.  **요약 결과 확인:** 앱은 AI가 요약한 내용을 화면에 표시합니다.

#### 7.2.4. 시스템 응답
1.  **요약 요청 시:**
    *   현재 노트의 `content`를 Supabase Edge Function으로 전송합니다.
    *   Edge Function은 외부 LLM API에 요약 요청을 보냅니다.
    *   LLM API로부터 받은 요약 결과를 Flutter 앱으로 반환합니다.
2.  **결과 표시:** 앱은 반환된 요약 결과를 파싱하여 사용자에게 보기 좋은 형태로 표시합니다.

#### 7.2.5. 데이터 모델 영향
*   **읽기:** AI 요약을 위해 노트의 `content` 필드를 읽습니다.
*   **수정:** (선택 사항) 요약된 내용을 노트의 메타데이터 필드에 저장할 수 있습니다.

#### 7.2.6. 오류 처리
*   **네트워크 오류:** AI 요약 중 네트워크 연결 문제 발생 시 알림을 제공합니다. (공통 오류 처리 규칙 참조)
*   **API 오류:** 외부 LLM API 또는 Edge Function에서 오류 발생 시 사용자에게 알림을 제공합니다. (공통 오류 처리 규칙 참조)
*   **권한 부족:** 프리미엄 구독자가 아닌 사용자가 요청 시 알림을 제공하고 기능을 제한합니다. (공통 오류 처리 규칙 참조)

#### 7.2.7. 사전/사후 조건
*   **사전 조건:**
    *   사용자가 프리미엄 구독자여야 합니다.
    *   노트가 존재하고, 요약할 내용이 충분히 있어야 합니다.
    *   네트워크 연결이 되어 있어야 합니다.
*   **사후 조건:** 노트 내용에 대한 AI 요약 결과가 화면에 표시됩니다.

### 7.3. AI 정리/분류 (노트 내용 자동 분석 및 정리)

#### 7.3.1. 개요
노트의 내용을 AI가 분석하여 자동으로 정리하거나 적절한 카테고리/태그를 제안하는 기능을 제공합니다. 프리미엄 구독자에게 제공되는 고급 AI 기능입니다.

#### 7.3.2. 사용자 인터페이스 (UI)
*   **노트 상세 화면:** 'AI 정리/분류' 버튼 또는 메뉴 옵션.
*   **정리/분류 결과 표시:** 제안된 태그, 카테고리, 또는 재구성된 노트 내용 표시.

#### 7.3.3. 사용자 상호작용
1.  **AI 정리/분류 요청:** 사용자가 노트 상세 화면에서 'AI 정리/분류' 버튼 또는 메뉴 옵션을 탭합니다.
2.  **결과 확인 및 적용:** 앱은 AI가 제안한 정리/분류 결과를 화면에 표시하고, 사용자가 이를 수락하여 노트에 적용할 수 있습니다.

#### 7.3.4. 시스템 응답
1.  **정리/분류 요청 시:**
    *   현재 노트의 `content`를 Supabase Edge Function으로 전송합니다.
    *   Edge Function은 외부 LLM API에 정리/분류 요청을 보냅니다.
    *   LLM API로부터 받은 결과(예: 제안된 태그 목록, 분류 카테고리, 재구성된 텍스트)를 Flutter 앱으로 반환합니다.
2.  **결과 표시 및 적용:** 앱은 반환된 결과를 파싱하여 사용자에게 표시하고, 사용자의 승인에 따라 노트의 메타데이터(태그, 카테고리)를 업데이트하거나 `content`를 재구성합니다.

#### 7.3.5. 데이터 모델 영향
*   **읽기:** AI 정리/분류를 위해 노트의 `content` 필드를 읽습니다.
*   **수정:** 노트의 `tags` (새로운 필드 또는 테이블), `category` (새로운 필드), 또는 `content` 필드가 갱신될 수 있습니다.

#### 7.3.6. 오류 처리
*   **네트워크 오류:** AI 정리/분류 중 네트워크 연결 문제 발생 시 알림을 제공합니다. (공통 오류 처리 규칙 참조)
*   **API 오류:** 외부 LLM API 또는 Edge Function에서 오류 발생 시 사용자에게 알림을 제공합니다. (공통 오류 처리 규칙 참조)
*   **권한 부족:** 프리미엄 구독자가 아닌 사용자가 요청 시 알림을 제공하고 기능을 제한합니다. (공통 오류 처리 규칙 참조)

#### 7.3.7. 사전/사후 조건
*   **사전 조건:**
    *   사용자가 프리미엄 구독자여야 합니다.
    *   노트가 존재하고, 분석할 내용이 충분히 있어야 합니다.
    *   네트워크 연결이 되어 있어야 합니다.
*   **사후 조건:** 노트 내용에 대한 AI 정리/분류 결과가 화면에 표시되거나 노트에 적용됩니다.

### 7.4. 사용량 제한/통계 (무료 vs 프리미엄)

#### 7.4.1. 개요
무료 회원의 AI 기능 사용량을 제한하고, 사용자에게 남은 사용량을 표시합니다. 프리미엄 구독자는 무제한으로 AI 기능을 사용할 수 있습니다. 사용자별 AI 기능 사용 통계를 관리합니다.

#### 7.4.2. 사용자 인터페이스 (UI)
*   **AI 기능 호출 시:**
    *   무료 회원의 경우, 남은 사용 횟수 또는 사용량 제한에 대한 메시지 표시.
    *   사용량 초과 시, 프리미엄 전환 유도 메시지 표시.
*   **설정 화면 또는 AI 기능 설정:** 사용자별 AI 사용 통계 (총 사용 횟수, 사용량 등) 표시.

#### 7.4.3. 사용자 상호작용
1.  **AI 기능 사용:** 사용자가 AI 사전, 요약, 분류 등 AI 기능을 호출합니다.
2.  **사용량 확인:** 무료 회원은 AI 기능 사용 시 남은 사용량을 확인합니다.
3.  **프리미엄 전환:** 사용량 초과 시 프리미엄 전환을 위한 안내를 따릅니다.

#### 7.4.4. 시스템 응답
1.  **AI 기능 호출 시:**
    *   Supabase Edge Function에서 사용자의 구독 상태 및 AI 사용량(무료 회원의 경우)을 확인합니다.
    *   무료 회원의 경우, 사용량 제한을 초과했는지 검사합니다.
    *   제한을 초과하지 않았다면 AI 기능을 실행하고 사용량을 차감합니다.
    *   제한을 초과했다면 AI 기능 실행을 거부하고 사용자에게 알림을 보냅니다.
2.  **사용 통계 관리:**
    *   `users` 테이블 또는 별도의 `ai_usage` 테이블에 사용자별 AI 기능 사용 횟수, 사용량 등을 기록합니다.
    *   이 데이터는 설정 화면 등에서 사용자에게 통계로 제공됩니다.

#### 7.4.5. 데이터 모델 영향
*   **수정:** `users` 테이블의 `ai_usage_count` (정수), `ai_last_reset_date` (날짜) 필드 또는 별도의 `ai_usage` 테이블 (user_id, feature_type, usage_count, date)이 갱신됩니다.

#### 7.4.6. 오류 처리
*   **사용량 제한 초과:** 무료 회원이 사용량 제한을 초과할 경우, 적절한 메시지를 표시하고 프리미엄 전환을 유도합니다. (공통 오류 처리 규칙 참조)

#### 7.4.7. 사전/사후 조건
*   **사전 조건:** 사용자가 AI 기능을 호출합니다.
*   **사후 조건:**
    *   무료 회원의 경우, AI 사용량 제한에 따라 기능 실행 여부가 결정됩니다.
    *   사용자별 AI 사용 통계가 갱신됩니다.

## 8. 계정/인증/결제

### 8.1. 회원가입/로그인/세션 관리

#### 8.1.1. 개요
사용자가 이메일/비밀번호 또는 소셜 계정을 통해 회원가입하고 로그인하여 앱 서비스를 이용할 수 있도록 합니다. 사용자 세션을 관리하여 로그인 상태를 유지합니다.

#### 8.1.2. 사용자 인터페이스 (UI)
*   **회원가입 화면:** 이메일, 비밀번호 입력 필드, '회원가입' 버튼, 소셜 로그인 버튼 (Google, Apple 등).
*   **로그인 화면:** 이메일, 비밀번호 입력 필드, '로그인' 버튼, '비밀번호 찾기' 링크, 소셜 로그인 버튼.
*   **설정 화면:** '로그아웃' 버튼, '계정 삭제' 옵션.

#### 8.1.3. 사용자 상호작용
1.  **회원가입:** 사용자가 회원가입 화면에서 정보를 입력하고 회원가입을 요청합니다.
2.  **로그인:** 사용자가 로그인 화면에서 정보를 입력하고 로그인을 요청합니다.
3.  **로그아웃:** 사용자가 설정 화면에서 '로그아웃' 버튼을 탭합니다.
4.  **세션 유지:** 앱 재실행 시 자동으로 로그인 상태가 유지됩니다.

#### 8.1.4. 시스템 응답
1.  **회원가입/로그인 요청 시:**
    *   Supabase Auth 서비스에 요청을 전송합니다.
    *   성공 시, Supabase Auth는 인증 토큰과 사용자 정보를 반환합니다.
    *   앱은 토큰을 안전하게 저장하고 사용자 세션을 시작합니다.
    *   로컬 DB의 비회원 노트를 클라우드 DB와 병합합니다.
2.  **로그아웃 요청 시:**
    *   Supabase Auth 세션을 종료하고 로컬에 저장된 토큰을 삭제합니다.
    *   사용자 세션이 종료되고 앱은 비로그인 상태로 전환됩니다.
3.  **세션 관리:**
    *   앱 시작 시 저장된 토큰의 유효성을 검사하여 사용자 세션을 복원합니다.
    *   토큰 만료 시 자동으로 갱신을 시도합니다.

#### 8.1.5. 데이터 모델 영향
*   **생성:** `users` 테이블에 새로운 사용자 레코드가 생성됩니다.
*   **수정:** 사용자 프로필 정보(`users` 테이블)가 갱신될 수 있습니다.

#### 8.1.6. 오류 처리
*   **인증 실패:** 유효하지 않은 이메일/비밀번호, 이미 존재하는 계정 등으로 인증에 실패할 경우, 사용자에게 알림을 제공합니다. (공통 오류 처리 규칙 참조)
*   **네트워크 오류:** 인증 요청 중 네트워크 문제 발생 시 알림을 제공합니다. (공통 오류 처리 규칙 참조)

#### 8.1.7. 사전/사후 조건
*   **사전 조건:** 네트워크 연결이 되어 있어야 합니다.
*   **사후 조건:**
    *   회원가입: 새로운 사용자 계정이 생성되고 로그인 상태가 됩니다.
    *   로그인: 사용자 세션이 시작되고 앱 서비스에 접근할 수 있습니다.
    *   로그아웃: 사용자 세션이 종료되고 앱 서비스 접근이 제한됩니다.

### 8.2. 프리미엄 구독 결제 및 영수증 검증

#### 8.2.1. 개요
사용자가 앱 내에서 프리미엄 구독 상품을 결제하고, 결제 영수증을 검증하여 구독 상태를 활성화하는 기능을 제공합니다.

#### 8.2.2. 사용자 인터페이스 (UI)
*   **프리미엄 구독 안내 화면:** 프리미엄 구독의 혜택, 가격 정보, '구독하기' 버튼.
*   **결제 진행 화면:** 플랫폼별(Google Play, Apple App Store) 결제 UI.
*   **결제 완료/실패 알림:** 결제 결과에 따른 메시지.

#### 8.2.3. 사용자 상호작용
1.  **구독 요청:** 사용자가 프리미엄 구독 안내 화면에서 '구독하기' 버튼을 탭합니다.
2.  **결제 진행:** 플랫폼별 결제 UI를 통해 결제를 진행합니다.
3.  **결제 완료:** 결제가 성공하면 영수증이 발급됩니다.

#### 8.2.4. 시스템 응답
1.  **결제 요청 시:**
    *   Flutter의 `in_app_purchase` 라이브러리를 통해 플랫폼별 결제 시스템을 호출합니다.
2.  **결제 완료 시:**
    *   플랫폼으로부터 받은 결제 영수증을 Supabase Edge Function으로 전송합니다.
    *   Edge Function은 해당 영수증을 각 플랫폼(Google/Apple)의 API를 통해 서버 측에서 검증합니다.
    *   검증 성공 시, `users` 테이블의 `premium_until` 및 `subscription_plan` 필드를 업데이트하고, 사용자에게 프리미엄 활성화 알림을 보냅니다.
    *   검증 실패 시, 사용자에게 알림을 보내고 결제 실패로 처리합니다.

#### 8.2.5. 데이터 모델 영향
*   **수정:** `users` 테이블의 `premium_until` (TIMESTAMP), `subscription_plan` (TEXT) 필드가 갱신됩니다.

#### 8.2.6. 오류 처리
*   **결제 실패:** 결제 시스템 오류, 카드 오류 등으로 결제에 실패할 경우, 사용자에게 알림을 제공합니다. (공통 오류 처리 규칙 참조)
*   **영수증 검증 실패:** 영수증이 유효하지 않거나 위변조된 경우, 사용자에게 알림을 제공하고 구독을 활성화하지 않습니다. (공통 오류 처리 규칙 참조)
*   **결제 취소/환불:** 사용자가 결제를 취소하거나 환불받을 경우, `premium_until` 및 `subscription_plan` 필드를 업데이트하여 프리미엄 상태를 해제합니다. (공통 오류 처리 규칙 참조)

#### 8.2.7. 사전/사후 조건
*   **사전 조건:**
    *   사용자가 로그인 상태여야 합니다.
    *   유효한 결제 수단이 등록되어 있어야 합니다.
*   **사후 조건:**
    *   결제 성공 시: 사용자의 프리미엄 구독이 활성화되고, `users` 테이블의 구독 관련 필드가 업데이트됩니다.
    *   결제 실패 시: 사용자에게 알림이 표시되고 구독이 활성화되지 않습니다.

### 8.3. 구독 상태 확인 및 권한 반영

#### 8.3.1. 개요
앱은 사용자의 현재 구독 상태를 확인하고, 이에 따라 제공되는 기능 및 UI를 동적으로 변경합니다. 사용자의 권한을 실시간으로 반영하여 프리미엄 기능 접근을 제어합니다.

#### 8.3.2. 사용자 인터페이스 (UI)
*   **프리미엄 기능:** 프리미엄 전용 기능(예: 고급 AI 기능, 무제한 프로젝트)은 무료 사용자에게 비활성화되거나, 잠금 아이콘과 함께 프리미엄 전환 유도 메시지가 표시됩니다.
*   **설정 화면:** 현재 구독 상태 (무료/프리미엄, 만료일) 표시.

#### 8.3.3. 사용자 상호작용
1.  **앱 실행/로그인:** 앱 실행 또는 로그인 시 사용자의 구독 상태가 자동으로 확인됩니다.
2.  **프리미엄 기능 접근 시도:** 무료 사용자가 프리미엄 기능에 접근하려 할 경우, 프리미엄 전환을 유도하는 메시지를 확인합니다.

#### 8.3.4. 시스템 응답
1.  **구독 상태 확인:**
    *   앱 시작 시 또는 로그인 시 `users` 테이블의 `premium_until` 필드를 확인하여 사용자의 현재 구독 상태를 판단합니다.
    *   만료일이 현재 날짜보다 미래이면 프리미엄, 아니면 무료로 간주합니다.
2.  **권한 반영:**
    *   판단된 구독 상태에 따라 앱의 UI 요소(버튼 활성화/비활성화, 잠금 아이콘 표시)를 동적으로 변경합니다.
    *   Supabase RLS 정책을 통해 백엔드 단에서도 프리미엄 기능에 대한 접근 권한을 제어합니다.

#### 8.3.5. 데이터 모델 영향
*   **읽기:** `users` 테이블의 `premium_until` 및 `subscription_plan` 필드를 읽습니다.

#### 8.3.6. 오류 처리
*   **상태 확인 실패:** 네트워크 오류 등으로 구독 상태 확인에 실패할 경우, 기본적으로 무료 사용자 권한을 적용하고 사용자에게 알림을 제공합니다. (공통 오류 처리 규칙 참조)

#### 8.3.7. 사전/사후 조건
*   **사전 조건:** 사용자가 로그인 상태여야 합니다.
*   **사후 조건:** 앱의 UI 및 기능 접근 권한이 사용자의 현재 구독 상태에 맞게 동적으로 반영됩니다.

## 9. 설정 및 부가 기능

### 9.1. 테마 선택/앱 환경 설정

#### 9.1.1. 개요
사용자가 앱의 시각적 테마(예: 라이트/다크 모드)를 선택하고, 기타 앱 환경 설정을 변경할 수 있는 기능을 제공합니다. 프리미엄 구독자에게는 추가 테마 옵션이 제공될 수 있습니다.

#### 9.1.2. 사용자 인터페이스 (UI)
*   **설정 화면:** '테마' 메뉴, '알림 설정', '데이터 관리' 등 다양한 설정 항목.
*   **테마 선택 화면:** 사용 가능한 테마 목록 (미리보기 포함), '선택' 버튼.

#### 9.1.3. 사용자 상호작용
1.  **설정 화면 진입:** 사용자가 메인 화면 또는 메뉴에서 '설정' 아이콘/버튼을 탭합니다.
2.  **테마 선택:** 설정 화면에서 '테마' 항목을 탭하고, 원하는 테마를 선택합니다.
3.  **환경 설정 변경:** 알림 설정, 데이터 관리 등 다른 설정 항목을 변경합니다.

#### 9.1.4. 시스템 응답
1.  **테마 선택 시:**
    *   선택된 테마 정보를 로컬 저장소(예: Shared Preferences)에 저장합니다.
    *   앱의 UI 테마를 즉시 변경하여 반영합니다.
    *   (프리미엄) 프리미엄 전용 테마 선택 시, 사용자의 구독 상태를 확인합니다.
2.  **환경 설정 변경 시:**
    *   변경 사항을 로컬 저장소 또는 Supabase DB에 저장하고 앱 동작에 반영합니다.

#### 9.1.5. 데이터 모델 영향
*   **수정:** 사용자 설정 정보(`users` 테이블 또는 별도 `user_settings` 테이블)가 갱신됩니다.

#### 9.1.6. 오류 처리
*   **설정 저장 실패:** 로컬 저장소 또는 DB 오류로 설정 저장에 실패할 경우, 사용자에게 알림을 제공합니다. (공통 오류 처리 규칙 참조)

#### 9.1.7. 사전/사후 조건
*   **사전 조건:** 앱이 실행 중이어야 합니다.
*   **사후 조건:** 앱의 시각적 테마 또는 환경 설정이 사용자의 선택에 따라 변경됩니다.

### 9.2. 노트 자동 백업/동기화 설정

#### 9.2.1. 개요
사용자가 노트의 자동 백업 및 동기화 설정을 관리할 수 있도록 합니다. 동기화 주기, Wi-Fi 전용 동기화 등 세부 옵션을 제공합니다.

#### 9.2.2. 사용자 인터페이스 (UI)
*   **설정 화면:** '동기화 설정' 또는 '데이터 백업' 메뉴.
*   **동기화 설정 화면:**
    *   자동 동기화 활성화/비활성화 토글.
    *   동기화 주기 선택 (예: 1시간마다, 매일, 수동).
    *   Wi-Fi 전용 동기화 토글.

#### 9.2.3. 사용자 상호작용
1.  **동기화 설정 진입:** 사용자가 설정 화면에서 '동기화 설정' 메뉴를 탭합니다.
2.  **옵션 변경:** 사용자가 자동 동기화 활성화 여부, 주기, Wi-Fi 전용 동기화 등을 설정합니다.

#### 9.2.4. 시스템 응답
1.  **설정 변경 시:**
    *   변경 사항을 로컬 저장소 또는 Supabase DB에 저장합니다.
    *   앱의 백그라운드 동기화 작업 스케줄을 업데이트합니다.

#### 9.2.5. 데이터 모델 영향
*   **수정:** 사용자 설정 정보(`users` 테이블 또는 별도 `user_settings` 테이블)가 갱신됩니다.

#### 9.2.6. 오류 처리
*   **설정 저장 실패:** 로컬 저장소 또는 DB 오류로 설정 저장에 실패할 경우, 사용자에게 알림을 제공합니다. (공통 오류 처리 규칙 참조)

#### 9.2.7. 사전/사후 조건
*   **사전 조건:** 앱이 실행 중이어야 합니다.
*   **사후 조건:** 노트 자동 백업 및 동기화 설정이 사용자의 선택에 따라 변경됩니다.

### 9.3. 고급 검색 (메타데이터 포함)

#### 9.3.1. 개요
노트 내용뿐만 아니라 메타데이터(생성일, 수정일, 태그, 프로젝트, 작성자 등)를 포함하여 노트를 검색할 수 있는 고급 검색 기능을 제공합니다. 프리미엄 구독자에게 제공됩니다.

#### 9.3.2. 사용자 인터페이스 (UI)
*   **검색 화면:** 일반 검색 외에 '고급 검색' 옵션 또는 버튼.
*   **고급 검색 화면:**
    *   검색어 입력 필드.
    *   메타데이터 필터 옵션 (예: 날짜 범위, 태그 선택, 프로젝트 선택, 작성자 선택).
    *   '검색' 버튼.

#### 9.3.3. 사용자 상호작용
1.  **고급 검색 진입:** 사용자가 검색 화면에서 '고급 검색' 옵션을 탭합니다.
2.  **검색 조건 입력:** 검색어와 함께 원하는 메타데이터 필터 조건을 입력합니다.
3.  **검색 실행:** '검색' 버튼을 탭합니다.
4.  **결과 확인:** 검색 조건에 맞는 노트 목록이 표시됩니다.

#### 9.3.4. 시스템 응답
1.  **고급 검색 요청 시:**
    *   입력된 검색어와 메타데이터 필터 조건을 조합하여 Supabase DB에 쿼리를 전송합니다.
    *   Supabase는 복합 쿼리를 실행하여 조건에 맞는 노트들을 조회합니다.
    *   조회된 결과를 Flutter 앱으로 반환합니다.
2.  **결과 표시:** 앱은 반환된 검색 결과를 파싱하여 노트 목록 형태로 표시합니다.

#### 9.3.5. 데이터 모델 영향
*   **읽기:** `notes` 테이블의 `title`, `content`, `created_at`, `updated_at`, `project_id`, `user_id` 및 `tags` (새로운 필드/테이블) 등 다양한 필드를 조회합니다.

#### 9.3.6. 오류 처리
*   **검색 실패:** 네트워크 오류, DB 오류 등으로 검색에 실패할 경우, 사용자에게 알림을 제공합니다. (공통 오류 처리 규칙 참조)
*   **권한 부족:** 프리미엄 구독자가 아닌 사용자가 요청 시 알림을 제공하고 기능을 제한합니다. (공통 오류 처리 규칙 참조)

#### 9.3.7. 사전/사후 조건
*   **사전 조건:**
    *   사용자가 프리미엄 구독자여야 합니다.
    *   검색할 노트가 존재해야 합니다.
    *   네트워크 연결이 되어 있어야 합니다.
*   **사후 조건:** 사용자가 지정한 고급 검색 조건에 맞는 노트 목록이 화면에 표시됩니다.